<!DOCTYPE html>
<html>
    <head>
        <title>Liminal</title>

        <style>
            * {
                margin: 0;
                padding: 0;
            }
            body {
                overflow: hidden;
                background-color: #000000;
            }
            canvas {
                border: 0px;
                position: absolute;
                display: block;
            }
        </style>

        <script id="v-shader" type="x-shader/x-vertex">
            uniform mat4 mMatrix;
            uniform mat4 nMatrix;
            uniform mat4 vMatrix;
            uniform mat4 pMatrix;

            attribute vec3 aVertexPosition;
            attribute vec3 aVertexNormal;
            //attribute vec3 aVertexColor;

            varying vec3 vPosition;
            varying vec3 vWorldPosition;
            varying vec3 vNormal;
            varying vec3 vWorldNormal;

            void main(void) {
                vPosition = aVertexPosition;
                vWorldPosition = (mMatrix * vec4(aVertexPosition, 0)).xyz;
                vNormal = aVertexNormal;
                vWorldNormal = (nMatrix * vec4(aVertexNormal, 0)).xyz;

                /*
                // DEBUG hardcode for now
                // setup lights
                vec3 ambientLight = vec3(.2, .2, .2);
                //vec3 diffuseLightColor = vec3(.5, .5, .8);
                //vec3 directionalLightPosition = normalize( vec3(1, 1, 1) );
                vec3 pointLightPosition = vec3(5.0, 5.0, 3.0);
                vec3 pointLightDirection = normalize(
                    vec3(pointLightPosition.xyz - aVertexPosition.xyz));
                vec3 l = normalize( vec3(pMatrix * vMatrix * mMatrix * vec4(pointLightDirection, 1.0)) );
                vec3 n = normalize( nMatrix * aVertexNormal)
                */
                //float diffuseLightFactor = max( dot(worldNormal, directionalLightPosition), 0.0 );
                //vLight = ambientLight + (diffuseLightColor * diffuseLightFactor);

                gl_Position = pMatrix * vMatrix * mMatrix * vec4(aVertexPosition, 1.0);
            }
        </script>

        <script id="f-shader" type="x-shader/x-fragment">
            precision mediump float;

            uniform highp mat4 mMatrix;
            uniform highp mat4 nMatrix;
            uniform highp mat4 vMatrix;
            uniform highp mat4 pMatrix;

            varying vec3 vPosition;
            varying vec3 vNormal;
            varying vec3 vWorldNormal;

            void main(void) {
                // DEBUG material props
                highp float roughness = 1.0;
                highp float ambientIntensity = 0.2;
                highp vec3 diffuseLightIntensity = vec3(0.9, 0.9, 0.9);
                highp float specularIntensity = 0.5;
                highp float shininess = 128.0;

                highp vec3 ambientColor = vec3(.5, .6, .7);
                highp vec3 diffuseColor = vec3(.7, .7, .3);
                highp vec3 specularColor = vec3(1, 1, 1);

                // light sources
                highp vec3 directionalLightVector = vec3(1, 1, 1);
                highp vec3 reversedDirectionalLightVector = normalize(-directionalLightVector);
                highp vec3 pointLightPosition = vec3(15, 15, 5);

                highp float opacity = 1.0;
                // <<<--- must be set by uniforms

                highp vec3 normal = normalize(vNormal);
                highp vec3 worldNormal = normalize(vWorldNormal);

                highp vec3 lWorldNormal = (nMatrix * vec4(normal, 0)).xyz;
                // apply dot product with a hard-coded directional light vector
                highp float diffuseLambert = max(
                    dot(
                        lWorldNormal,
                        normalize(vec3(1, 1, 1))), // directional light
                    0.0
                );

                /*
                highp vec3 pointLightDirection = vec3(
                    pointLightPosition.xyz - vPosition.xyz);

                highp mat4 mvp = pMatrix * vMatrix * mMatrix;

                highp vec3 l = normalize( vec3(mvp * vec4(pointLightDirection, 1.0)) );
                highp vec3 v = normalize( -vec3(mvp * vec4(vPosition, 1.0)) );

                highp vec3 n = normalize( vec3( nMatrix * vec4(vNormal, 0) ));
                //highp vec3 n = normalize( vec3( nMatrix * vec4(vNormal, 0) ) );
                //highp mat4 imMatrix = transpose(inverse(mMatrix));
                //highp vec3 n = normalize( vec3( imMatrix * vec4(vNormal), 0) );

                //highp float diffuseLambert = dot(l, n);
                highp float diffuseLambert = max(
                    dot(vWorldNormal, normalize(directionalLightPosition)), 0.0 );

                highp vec3 R = reflect(l, n);
                highp float specular = pow( max(0.0, dot(R, v)), shininess);
                */

                gl_FragColor = vec4(
                    ambientColor * ambientIntensity
                    + diffuseColor * diffuseLambert * diffuseLightIntensity, 
                    //+ diffuseColor * diffuseLightIntensity
                    //+ specularColor * specular * specularIntensity,
                    opacity);
            }
        </script>

        <script src="js/math.js"></script>
        <script src="js/util.js"></script>
        <script src="js/geo.js"></script>

        <script src="js/dna/Frame.js"></script>
        <script src="js/dna/Camera.js"></script>
        <script src="js/dna/Cube.js"></script>
        <script src="js/dna/Mesh.js"></script>

        <script src="js/env.js"></script>
        <script src="js/trap.js"></script>
        <script src="js/setup.js"></script>
        <script src="js/scene.js"></script>
        <script src="js/cycle.js"></script>

        <script src="box/box1.js"></script>
    </head>

    <body>
        <canvas id="canvas"></canvas>
        <canvas id="hcanvas"></canvas>
    </body>
</html>
