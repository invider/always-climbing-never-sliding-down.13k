#!/bin/sh

SRC=./mod
DIST=./dist
STAGE=$DIST/stage
TAR=$DIST/target
ZIP=game.zip

echo "Indexing source files..."
./index

echo "Cleaning..."
./clean

echo "Staging the Package..."
mkdir -p $DIST
mkdir -p $STAGE
cp --verbose $SRC/*.css $STAGE/
cp --verbose $SRC/html/*.html $STAGE/

cp --verbose -r $SRC/dry   $STAGE/
cp --verbose -r $SRC/jet   $STAGE/
cp --verbose -r $SRC/stage $STAGE/

# initial size estimates
#du -shb $STAGE/*.html
#du -shb $STAGE/js/*.js

# minify
echo "=============="
echo "=   Minify   ="
echo "=============="
mkdir -p $TAR
node ./tools/minify.js $STAGE $TAR

# just copy html fo now
# TODO minify .html and .css files
cp --verbose $STAGE/*.html $TAR
cp --verbose $STAGE/*.css $TAR


echo "============="
echo "=    ZIP    ="
echo "============="
echo "Creating the archive from [$TAR]..."
cd $TAR
pwd
zip -r $ZIP *
mv --verbose $ZIP ../
cd -

echo "---------------------------------"
echo "Test unpackaging of [$ZIP]..."
cd dist
mkdir $ZIP.out
unzip -v $ZIP
unzip $ZIP -d $ZIP.out
cd -

echo '-------------------------------'
du -shb $DIST/*.zip
du -sh --apparent-size $DIST/*.zip
echo '-------------------------------'
